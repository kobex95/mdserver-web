<!doctype html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon" />
<title>{{data['title']}}</title>
<link rel="stylesheet" type="text/css" href="/static/layer/skin/default/layer.css?v={{config.version}}">
<link rel="stylesheet" type="text/css" href="/static/css/login-modern.css?v={{config.version}}">
<style type="text/css">
/* è‡ªå®šä¹‰åŠ¨ç”»ç²’å­ */
.particle:nth-child(1) { left: 10%; animation-delay: 0s; width: 4px; height: 4px; }
.particle:nth-child(2) { left: 20%; animation-delay: 2s; width: 6px; height: 6px; }
.particle:nth-child(3) { left: 30%; animation-delay: 4s; width: 3px; height: 3px; }
.particle:nth-child(4) { left: 40%; animation-delay: 1s; width: 5px; height: 5px; }
.particle:nth-child(5) { left: 50%; animation-delay: 3s; width: 4px; height: 4px; }
.particle:nth-child(6) { left: 60%; animation-delay: 5s; width: 6px; height: 6px; }
.particle:nth-child(7) { left: 70%; animation-delay: 2s; width: 3px; height: 3px; }
.particle:nth-child(8) { left: 80%; animation-delay: 4s; width: 5px; height: 5px; }
.particle:nth-child(9) { left: 90%; animation-delay: 1s; width: 4px; height: 4px; }
</style>
</head>
<body>
<!-- èƒŒæ™¯ç²’å­æ•ˆæœ -->
<div class="particles">
  <div class="particle"></div>
  <div class="particle"></div>
  <div class="particle"></div>
  <div class="particle"></div>
  <div class="particle"></div>
  <div class="particle"></div>
  <div class="particle"></div>
  <div class="particle"></div>
  <div class="particle"></div>
</div>

<div class="login-container">
  <div class="login-card">
    <div class="login-logo">
      <h1>{{data['title']}}</h1>
      <p>æ–°ä¸€ä»£LinuxæœåŠ¡å™¨ç®¡ç†é¢æ¿</p>
    </div>
    
    <form class="login-form" method="post" action="/login" onsubmit="return false;">
      <div class="form-group">
        <label for="username">ç”¨æˆ·å</label>
        <div style="position: relative;">
          <input type="text" id="username" name="username" class="login-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="off" required>
          <span class="input-icon">ğŸ‘¤</span>
        </div>
      </div>
      
      <div class="form-group">
        <label for="password">å¯†ç </label>
        <div style="position: relative;">
          <input type="password" id="password" name="password" class="login-input" placeholder="è¯·è¾“å…¥å¯†ç " required>
          <span class="input-icon">ğŸ”’</span>
        </div>
      </div>
      
      {% if session['code'] %}
      <div class="form-group captcha-group">
        <label for="code">éªŒè¯ç </label>
        <div class="captcha-container">
          <div style="position: relative; flex: 1;">
            <input type="text" id="code" name="code" class="login-input captcha-input" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="4" required>
            <span class="input-icon">ğŸ›¡ï¸</span>
          </div>
          <img id="captcha-img" class="captcha-image" src="/code" onclick="refreshCaptcha()" title="ç‚¹å‡»åˆ·æ–°éªŒè¯ç ">
        </div>
      </div>
      {% endif %}
      
      <div class="error-message" id="error-message"></div>
      
      <button type="submit" class="login-button" id="login-button">
        <span class="button-text">ç™»å½•ç³»ç»Ÿ</span>
      </button>
    </form>
    
    <div class="forgot-password">
      <a href="//github.com/midoks/mdserver-web/wiki/%E5%AF%86%E7%A0%81%E4%BF%AE%E6%94%B9" target="_blank">å¿˜è®°å¯†ç ï¼Ÿ</a>
    </div>
  </div>
</div>

<script type="text/javascript" src="/static/js/jquery-1.10.2.min.js?v={{config.version}}"></script>
<script src="/static/language/zh-cn.js?v={{config.version}}"></script>
<script src="/static/language/Simplified_Chinese/lan.js?v={{config.version}}"></script>
<script src="/static/layer/layer.js?v={{config.version}}"></script>
<script type="text/javascript">
$(function(){
  // è¡¨å•éªŒè¯å’Œæäº¤
  $('.login-form').on('submit', function(e){
    e.preventDefault();
    handleLogin();
  });
  
  // å›è½¦é”®æäº¤
  $('.login-input').on('keypress', function(e){
    if(e.which === 13) {
      handleLogin();
    }
  });
  
  // è¾“å…¥æ¡†ç„¦ç‚¹æ•ˆæœ
  $('.login-input').on('focus', function(){
    $(this).closest('.form-group').removeClass('error success');
    $('#error-message').removeClass('show');
  });
});

function handleLogin(){
  const username = $('#username').val().trim();
  const password = $('#password').val().trim();
  const code = $('#code').val().trim();
  
  // åŸºç¡€éªŒè¯
  if(!username || !password) {
    showError('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
    return;
  }
  
  if($('#code').length && !code) {
    showError('è¯·è¾“å…¥éªŒè¯ç ');
    return;
  }
  
  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  const button = $('#login-button');
  const buttonText = $('.button-text');
  button.addClass('loading');
  buttonText.text('ç™»å½•ä¸­...');
  button.prop('disabled', true);
  
  // æäº¤ç™»å½•è¯·æ±‚
  $.post('/do_login', {
    username: encodeURIComponent(username),
    password: encodeURIComponent(password),
    code: code
  }, function(response){
    button.removeClass('loading');
    buttonText.text('ç™»å½•ç³»ç»Ÿ');
    button.prop('disabled', false);
    
    if(response.status && response.status > 0) {
      // ç™»å½•æˆåŠŸ
      if(response.status === 2) {
        // äºŒæ¬¡éªŒè¯
        handleTwoFactorAuth(username, password);
      } else {
        // ç›´æ¥ç™»å½•
        showSuccess('ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...');
        setTimeout(() => {
          window.location.href = '/';
        }, 1000);
      }
    } else {
      // ç™»å½•å¤±è´¥
      showError(response.msg || 'ç™»å½•å¤±è´¥');
      
      // åˆ·æ–°éªŒè¯ç 
      if(response.msg && response.msg.includes('éªŒè¯ç ')) {
        refreshCaptcha();
        $('#code').val('').focus();
      } else {
        $('#password').val('').focus();
      }
      
      // æ¸…ç©ºè¡¨å•çŠ¶æ€
      $('.form-group').removeClass('success error');
    }
  }, 'json').fail(function(){
    button.removeClass('loading');
    buttonText.text('ç™»å½•ç³»ç»Ÿ');
    button.prop('disabled', false);
    showError('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  });
}

function handleTwoFactorAuth(username, password){
  layer.prompt({
    formType: 3,
    value: '',
    title: 'äºŒæ­¥éªŒè¯',
    area: ['300px', '180px']
  }, function(value, index, elem){
    $.post('/verify_login', {
      'auth': value,
      'username': username,
      'password': password
    }, function(vdata){
      if(vdata.status && vdata.status > 0){
        layer.close(index);
        showSuccess('éªŒè¯æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...');
        setTimeout(() => {
          window.location.href = '/';
        }, 1000);
      } else {
        layer.msg(vdata.msg || 'éªŒè¯å¤±è´¥', {icon: 2});
      }
    }, 'json');
  });
}

function showError(message){
  const errorEl = $('#error-message');
  errorEl.text(message).addClass('show');
  
  // æ·»åŠ éœ‡åŠ¨æ•ˆæœ
  $('.login-card').addClass('shake');
  setTimeout(() => {
    $('.login-card').removeClass('shake');
  }, 500);
  
  // 3ç§’åè‡ªåŠ¨éšè—
  setTimeout(() => {
    errorEl.removeClass('show');
  }, 3000);
}

function showSuccess(message){
  layer.msg(message, {icon: 1});
}

function refreshCaptcha(){
  const captchaImg = $('#captcha-img');
  const timestamp = new Date().getTime();
  const src = captchaImg.attr('src').split('?')[0] + '?' + timestamp;
  captchaImg.attr('src', src);
  
  // æ·»åŠ åˆ·æ–°åŠ¨ç”»
  captchaImg.css('transform', 'rotate(360deg)');
  setTimeout(() => {
    captchaImg.css('transform', '');
  }, 500);
}

// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
$(document).ready(function(){
  // èšç„¦åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
  $('#username').focus();
  
  // æ·»åŠ é¡µé¢åŠ è½½åŠ¨ç”»
  $('body').css('opacity', '0');
  setTimeout(() => {
    $('body').animate({opacity: 1}, 800);
  }, 100);
});
</script>
</body>
</html>